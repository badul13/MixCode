import os
import zipfile
import json
import pandas as pd

# 1. ZIP í•´ì œ í•¨ìˆ˜
def unzip_file(zip_path, extract_to):
    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
        zip_ref.extractall(extract_to)
    print(f"ğŸ“‚ {zip_path} ì••ì¶• í•´ì œ ì™„ë£Œ â†’ {extract_to}")

# 2. ì¤‘ì²© ZIP í•´ì œ
def unzip_nested_zip_files(folder_path):
    for root, _, files in os.walk(folder_path):
        for file in files:
            if file.endswith('.zip'):
                zip_path = os.path.join(root, file)
                extract_to = os.path.splitext(zip_path)[0]
                
                try:
                    with zipfile.ZipFile(zip_path, 'r') as zip_ref:
                        zip_ref.extractall(extract_to)
                    print(f"ğŸ“¦ ì¤‘ì²© ZIP í•´ì œ: {zip_path} â†’ {extract_to}")
                except Exception as e:
                    print(f"âš ï¸ {zip_path} í•´ì œ ì‹¤íŒ¨: {e}")

# 3. JSON ë¡œë“œ ë° ë³¸ë¬¸ ì¶”ì¶œ í•¨ìˆ˜
def extract_all_json_files(path):
    json_data = []
    for root, _, files in os.walk(path):
        for file in files:
            if file.endswith(".json"):
                file_path = os.path.join(root, file)
                try:
                    with open(file_path, "r", encoding="utf-8") as f:
                        data = json.load(f)
                        if isinstance(data, list):
                            json_data.extend(data)
                        elif isinstance(data, dict):
                            json_data.append(data)
                except Exception as e:
                    print(f"â— JSON ë¡œë“œ ì‹¤íŒ¨: {file_path} - {e}")
    return json_data

def extract_newscontent_from_json(directory):
    result = []
    for root, _, files in os.walk(directory):
        for file in files:
            if file.endswith('.json'):
                try:
                    with open(os.path.join(root, file), 'r', encoding='utf-8') as f:
                        data = json.load(f)
                        # ë°ì´í„° í˜•ì‹ì´ ë¦¬ìŠ¤íŠ¸ë©´ ë°˜ë³µ
                        if isinstance(data, list):
                            for item in data:
                                content = item.get('labeledDataInfo', {}).get('newsContent', '')
                                if content:
                                    result.append({'content': content})
                        elif isinstance(data, dict):
                            content = data.get('labeledDataInfo', {}).get('newsContent', '')
                            if content:
                                result.append({'content': content})
                except Exception as e:
                    print(f"âš ï¸ JSON ë¡œë“œ ì‹¤íŒ¨: {file}, ì´ìœ : {e}")
    return result

# 4. ë©”ì¸ í•¨ìˆ˜
def main():
    # ê²½ë¡œ ì„¤ì •
    zip1 = "/content/drive/MyDrive/ColabNotebooks/opendata1.zip"
    zip2 = "/content/drive/MyDrive/ColabNotebooks/opendata2.zip"
    extract_path1 = "/content/data1"
    extract_path2 = "/content/data2"

    # ì••ì¶• í•´ì œ
    print("ğŸ”½ ZIP ì••ì¶• í•´ì œ ì¤‘...")
    unzip_file(zip1, extract_path1)
    unzip_file(zip2, extract_path2)

    print("ğŸ”½ ì¤‘ì²© ZIP íŒŒì¼ í•´ì œ ì¤‘...")
    unzip_nested_zip_files(extract_path1)
    unzip_nested_zip_files(extract_path2)

    print("ğŸ”½ JSON íŒŒì¼ ë¡œë“œ ì¤‘...")
    fake_data1 = extract_newscontent_from_json(extract_path1)
    fake_data2 = extract_newscontent_from_json(extract_path2)
    all_fake_data = fake_data1 + fake_data2

    if not all_fake_data:
        raise ValueError("âŒ ê°€ì§œ ë‰´ìŠ¤ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨.")

    fake_df = pd.DataFrame(all_fake_data)
    fake_df['label'] = 1
    print("âœ… ê°€ì§œ ë‰´ìŠ¤ DataFrame ìƒì„± ì™„ë£Œ:", fake_df.shape)

    # ì§„ì§œ ë‰´ìŠ¤ ë¡œë“œ
    print("ğŸ”½ ì§„ì§œ ë‰´ìŠ¤ CSV ë¡œë“œ ì¤‘...")
    newsdata_path = "/content/newsdata.csv"
    real_df = pd.read_csv(newsdata_path, encoding='utf-8-sig')

    text_col_real = None
    for col in real_df.columns:
        if real_df[col].apply(lambda x: isinstance(x, str)).mean() > 0.8:
            text_col_real = col
            break
    if text_col_real is None:
        raise ValueError("âŒ ì§„ì§œ ë‰´ìŠ¤ í…ìŠ¤íŠ¸ ì»¬ëŸ¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    real_df = real_df.rename(columns={text_col_real: 'content'})
    real_df = real_df[['content']].dropna()
    real_df['label'] = 0

    # ë³‘í•© ë° ì €ì¥
    final_df = pd.concat([fake_df, real_df], ignore_index=True).sample(frac=1, random_state=42).reset_index(drop=True)
    output_path = "/content/opendata_output.csv"
    final_df.to_csv(output_path, index=False, encoding='utf-8-sig')
    print(f"âœ… ìµœì¢… CSV ì €ì¥ ì™„ë£Œ: {output_path}")
    print(final_df.head())

# ğŸ”„ ì‹¤í–‰
if __name__ == "__main__":
    main()
